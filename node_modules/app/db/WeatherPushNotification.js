var mongoose = require('app/db/mongoose_connect.js');
var Schema = mongoose.Schema;
var ObjectId = Schema.Types.ObjectId;

var Globals = require('app/helpers/Globals.js');
var vsprintf = require("sprintf-js").vsprintf;

var customSchema = new Schema({
        raining: {type: Boolean, default: false},
        snowing : {type: Boolean, default: false},
        sentAt : {type: Date}
    },
    {timestamps: {createdAt: 'dateCreated', updatedAt: 'dateUpdated'}}
);

customSchema.virtual('').get(function () {
});


customSchema.pre("save", function (next) {
    next();
});

customSchema.post("init", function (doc) {

});

customSchema.statics.sendWeatherPushNotificationsToUsers = function(users){

    var User = mongoose.model("User");
    var zipcodes = {};
    var WeatherPushNotification = this;
    var WeatherAtZipcode = mongoose.model("WeatherAtZipcode");

    users.forEach(function(user){
        if (user.zipcode) {
            if (!zipcodes[user.zipcode]){
                zipcodes[user.zipcode] = [];
            }
            zipcodes[user.zipcode].push(user);
        }
    });


    Globals.loopThroughObject(zipcodes, function(zipcode, _users){

        WeatherAtZipcode.findOne({zipcode : zipcode}).exec(function(err, weather){
            if (err){
                console.log(err);
            }
            else if (!weather){
                console.log("WeatherPushNotification.sendWeatherPushNotifications - no weather");
            }
            else{
                WeatherPushNotification.sendWeatherPushNotifications(weather, _users);
            }

        });
    });
};

customSchema.statics.sendWeatherPushNotifications = function(weatherAtZipcode, users){
    var User = mongoose.model("User");

    weatherAtZipcode.populate("_current_forecast", function(err, _weather){
       if (err){
           console.log(err);
       }
        else{
           var forecast = _weather._current_forecast;

           var weatherDesc = weatherAtZipcode.weatherDescription();

           var message = "Hey! %s";
           var tempArgs = [weatherDesc];

           var msg = vsprintf(message, tempArgs);

           User.sendPushNotifications(users, "Good Morning!", msg);
       }
    });
};

module.exports = mongoose.model('WeatherPushNotification', customSchema);