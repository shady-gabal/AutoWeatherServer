var mongoose = require('app/db/mongoose_connect.js');
var Schema = mongoose.Schema;
var ObjectId = Schema.Types.ObjectId;

var Globals = require('app/helpers/Globals.js');
var onesignal = require('node-opensignal-api');
var onesignal_client = onesignal.createClient();


var customSchema = new Schema({
        udid: {type: String, required: true},
        secret_key : {type: String},
        zipcode: {type: String, required: true},
        notification_time: {type: String},
        last_notification_date : {type: Date},
        onesignal_id : {type: String},
        push_tokens : [{os: String, token: String}]
    },
    {timestamps: {createdAt: 'dateCreated', updatedAt: 'dateUpdated'}}
);

customSchema.virtual('').get(function () {
});


customSchema.pre("save", function (next) {
    next();
});

customSchema.post("init", function (doc) {

});

customSchema.statics.sendPushNotifications = function(users, title, message){
    var onesignal_ids = [];
    users.forEach(function(user){
        onesignal_ids.push(user.onesignal_id);
    });

    var params = {
        app_id: process.env.ONESIGNAL_APP_ID,
        contents: {
            'en': message
        },
        headings: {
            'en' : title
        },
        ios_badgeType: "Increase",
        ios_badgeCount: 1,
        include_player_ids: onesignal_ids
    };

    onesignal_client.notifications.create(process.env.ONESIGNAL_API_KEY, params, function (err, response) {
        if (err) {
            console.log('Onesignal error:', err);
        } else {
            console.log(response);
        }
    });
};

customSchema.methods.sendPushNotification = function(title, message){
    mongoose.model("User").sendPushNotifications([this], title, message);
};

module.exports = mongoose.model('User', customSchema);